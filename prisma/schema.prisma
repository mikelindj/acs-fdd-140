generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Admin {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("admins")
}

model Guest {
  id             String       @id @default(cuid())
  name           String
  email          String?      @unique
  mobile         String?
  birthYear      Int?
  school         String?
  gradYear       Int?
  dietary        String?
  isVip          Boolean      @default(false)
  membershipNo   String?
  tableId        String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  bookings       Booking[]    @relation("GuestBookings")
  table          Table?       @relation("TableGuests", fields: [tableId], references: [id])
  invites        InviteCode[] @relation("GuestInvites")
  bookingAsGuest Booking[]    @relation("BookingGuests")

  @@index([email])
  @@index([tableId])
  @@map("guests")
}

model Table {
  id          String      @id @default(cuid())
  tableNumber String      @unique
  capacity    Int
  status      TableStatus @default(AVAILABLE)
  tableHash   String      @unique
  x           Float?
  y           Float?
  bookingId   String?     @unique
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  guests      Guest[]     @relation("TableGuests")
  booking     Booking?    @relation(fields: [bookingId], references: [id])

  @@index([tableHash])
  @@index([status])
  @@map("tables")
}

model Booking {
  id              String          @id @default(cuid())
  type            BookingType
  category        BookingCategory
  quantity        Int
  totalAmount     Decimal         @db.Decimal(10, 2)
  transactionFee  Decimal?        @db.Decimal(10, 2)
  balanceDue      Decimal         @default(0) @db.Decimal(10, 2)
  hitpayPaymentId String?         @unique
  status          PaymentStatus   @default(PENDING)
  buyerId         String
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  buyer           Guest           @relation("GuestBookings", fields: [buyerId], references: [id])
  inviteCodes     InviteCode[]    @relation("BookingInvites")
  table           Table?
  guests          Guest[]         @relation("BookingGuests")

  @@index([buyerId])
  @@index([status])
  @@index([hitpayPaymentId])
  @@map("bookings")
}

model InviteCode {
  id        String    @id @default(cuid())
  code      String    @unique
  bookingId String
  guestId   String?
  email     String?
  claimedAt DateTime?
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  booking   Booking   @relation("BookingInvites", fields: [bookingId], references: [id], onDelete: Cascade)
  guest     Guest?    @relation("GuestInvites", fields: [guestId], references: [id])

  @@index([code])
  @@index([bookingId])
  @@map("invite_codes")
}

model EmailLog {
  id      String   @id @default(cuid())
  to      String
  subject String
  type    String
  sentAt  DateTime @default(now())
  status  String   @default("sent")
  error   String?

  @@index([to])
  @@index([type])
  @@map("email_logs")
}

enum BookingType {
  TABLE
  SEAT
}

enum BookingCategory {
  VIP
  SCHOOL
  OBA
  GUEST
}

enum TableStatus {
  AVAILABLE
  RESERVED
  FULL
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}
